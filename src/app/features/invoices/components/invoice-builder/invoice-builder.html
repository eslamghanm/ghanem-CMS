<div class="space-y-4">
  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
    <div class="md:col-span-2">
      <label class="label">Patient</label>
      <select class="input" [formControl]="form.controls.patientId">
        <option value="">Select patient</option>
        <option *ngFor="let p of patients.list()" [value]="p.id">{{ p.name }}</option>
      </select>
    </div>
    <div>
      <label class="label">Discount Type</label>
      <select class="input" [formControl]="form.controls.discountType">
        <option value="percent">Percent</option>
        <option value="fixed">Fixed</option>
      </select>
    </div>
    <div>
      <label class="label">Discount Value</label>
      <input class="input" type="number" [formControl]="form.controls.discountValue" />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <div class="text-sm font-medium mb-2">Treatments</div>
      <div class="h-64 overflow-auto border rounded-md divide-y dark:divide-neutral-800 dark:border-neutral-800">
        <div *ngFor="let t of treatments.list()" class="px-3 py-2 flex items-center justify-between">
          <div>
            <div class="font-medium">{{ t.name }}</div>
            <div class="text-xs text-neutral-500">{{ t.code || '-' }} • {{ t.basePrice | currency }}</div>
          </div>
          <button class="btn btn-outline" (click)="addTreatment(t.id)">Add</button>
        </div>
      </div>
    </div>
    <div>
      <div class="text-sm font-medium mb-2">Invoice Items</div>
      <div class="h-64 overflow-auto border rounded-md divide-y dark:divide-neutral-800 dark:border-neutral-800">
        <div *ngFor="let it of items; let i = index" class="px-3 py-2 flex items-center justify-between gap-2">
          <div class="flex-1">
            <div class="font-medium">{{ it.name }}</div>
            <div class="text-xs text-neutral-500">{{ it.unitPrice | currency }} x
              <input class="input w-16 inline-block ml-1" type="number" [(ngModel)]="it.quantity" (ngModelChange)="it.subtotal=it.unitPrice*it.quantity" />
              = {{ it.subtotal | number:'1.2-2' }}</div>
          </div>
          <button class="btn btn-outline" (click)="removeItem(i)">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-between">
    <div>
      <label class="label">Payment Method</label>
      <input class="input w-48" [formControl]="form.controls.paymentMethod" />
    </div>
    <div class="flex items-center gap-2">
      <button class="btn btn-outline" (click)="showPreview = true">Preview</button>
      <button class="btn btn-outline" (click)="save('draft')">Save Draft</button>
      <button class="btn btn-primary" (click)="save('paid')">Save Paid</button>
    </div>
  </div>

  <div *ngIf="showPreview" class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50" (click)="showPreview=false">
    <div class="bg-white dark:bg-neutral-900 rounded-t-2xl md:rounded-2xl w-full md:w-[680px] max-h-[80vh] overflow-auto" (click)="$event.stopPropagation()">
      <div class="p-4 border-b dark:border-neutral-800 flex items-center justify-between">
        <div class="font-medium">Invoice Preview</div>
        <button class="btn btn-outline" (click)="showPreview=false">Close</button>
      </div>
      <div class="p-4">
        <div class="text-sm text-neutral-500">Patient</div>
        <div class="font-medium mb-2">{{ patients.get(form.value.patientId || '')?.name || '-' }}</div>
        <div class="divide-y dark:divide-neutral-800">
          <div *ngFor="let it of items" class="py-2 flex items-center justify-between">
            <div>{{ it.name }} × {{ it.quantity }}</div>
            <div>{{ (it.unitPrice * it.quantity) | currency }}</div>
          </div>
        </div>
        <div class="mt-3 text-right text-sm">
          <div>Discount: {{ form.value.discountType }} {{ form.value.discountValue }}</div>
          <div>Tax: {{ (settings.get().taxRate * 100) | number:'1.0-0' }}%</div>
        </div>
      </div>
    </div>
  </div>
</div>
